// Generated by CoffeeScript 1.6.3
(function() {
  var DC_CITYS, MongoClient, Schema, csv, fs, mongoose, path, pathToCSVFile;

  mongoose = require('mongoose');

  Schema = mongoose.Schema;

  path = require("path");

  fs = require("fs");

  csv = require("fast-csv");

  MongoClient = require("mongodb").MongoClient;

  DC_CITYS = ["北京", "南京", "上海", "汉口", "青岛", "大连", "沈阳", "哈尔", "西安", "天津", "重庆", "广州", "深圳", "香港", "台湾", "澳门"];

  console.log("[mongo-performance::init] %j", process.argv);

  pathToCSVFile = process.argv[2];

  if (!fs.existsSync(pathToCSVFile)) {
    console.log("[mongo-performance::init] missing csv sample at:" + pathToCSVFile);
    process.exit(1);
  }

  MongoClient.connect("mongodb://127.0.0.1:27017/kf", function(err, db) {
    var collection, count, countInsert, job;
    if (err) {
      throw err;
    }
    collection = db.collection("members");
    console.log("[mongo-performance::init] db is ready");
    count = 0;
    countInsert = 0;
    job = csv(pathToCSVFile, {
      headers: true
    });
    job.on("data", function(data) {
      var address, idCardNum, pos, province;
      ++count;
      delete data["id"];
      delete data["Version"];
      delete data["Taste"];
      idCardNum = String(data["CtfId"] || "");
      if (idCardNum.length === 18) {
        data.birthYear = parseInt(idCardNum.substr(6, 4));
        data.birthMonth = parseInt(idCardNum.substr(10, 2));
        data.provinceCode = parseInt(idCardNum.substr(0, 3));
        data.regionCode = parseInt(idCardNum.substr(0, 6));
      } else if (idCardNum.length === 15) {
        data.birthYear = parseInt("19" + (idCardNum.substr(6, 2)));
        data.birthMonth = parseInt(idCardNum.substr(8, 2));
        data.provinceCode = parseInt(idCardNum.substr(0, 3));
        data.regionCode = parseInt(idCardNum.substr(0, 6));
      } else {
        data.birthYear = parseInt(String(data["Birthday"] || "").substr(0, 4));
        data.birthMonth = parseInt(String(data["Birthday"] || "").substr(4, 2));
      }
      address = data["Address"] || "";
      pos = address.indexOf("省");
      if (pos > 0 && pos < 5) {
        province = address.substring(0, pos);
      } else {
        if ((pos = DC_CITYS.indexOf(address.substr(0, 2))) > 0) {
          province = DC_CITYS[pos];
        }
      }
      if (province != null) {
        data["province"] = province;
      }
      console.log("[mongo-performance::csv::ondata] %j \n count:%d", data, count);
      collection.insert(data, function(err, docs) {
        if (err != null) {
          return console.log("[mongo-performance::db::insert] " + err);
        } else {
          ++countInsert;
          return console.log("[mongo-performance::db::insert] succeed:%j \n insert count:%d", docs, countInsert);
        }
      });
    });
    job.on("error", function(err) {
      console.error("[mongo-performance::job] csv paring error:" + err);
    });
    job.on("end", function() {
      job.removeAllListeners();
      console.log("[mongo-performance::csv::on end] processed %d records", count);
    });
    return job.parse();
  });

}).call(this);
